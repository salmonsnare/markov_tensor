# markov_tensor

## 概要
Python によるマルコフ・テンソルの計算をするスクリプトです。

## 構成
- markov_tensor.py: テンソル計算を実施するメソッドをもつ本体です。

次の 2 個のスクリプトはmarkov_tensor.py からメソッドを呼び出しており、使用例になっています。
- ball_lamp.py: README で説明している例のスクリプトです。
- string_label.py: インデックスとして文字列のラベルをもつ計算例です。
- shadow.py: 影絵クイズと呼ばれるクイズの計算例です。

## markov_tensor.py で実装したメソッド
テンソル計算: 
- 結合演算: メソッド composition
- 恒等射: メソッド identity
- 部分結合: メソッド partial composition
- 同時化: メソッド jointification
- 条件化: メソッド conditionalization
- テンソル積: メソッド tensor_product
- 第一周辺化: メソッド first_marginalization
- 第二周辺化: メソッド second_marginalization
- 反転: メソッド: conversion

テンソルを構成
- 単位テンソル: メソッド unit_tensor
- マルコフ・テンソル Δ: メソッド delta
- マルコフ・テンソル ！: メソッド exclamation
- マルコフ・テンソル Xa,b (スワップ): メソッド swap

## はじめに
### 本スクリプトにおける計算の基本
次のような行と列にインデックスをもつ表を考えます。

ここで、それぞれの列の総和は 1 として、
ある列のインデックスで表現される事象ならば、
ある行のインデックスで表現される事象である確率を、
該当する表のセルに書きます。

例として、次のような表1 と 2 を示します。

表1. 
黒、または白のボールが混在した容器から、
黒、または白のボールを 1 個選んだ後、その色によって、
赤、緑、または青にランダムに発光するランプの確率の表。 

```console
　　黒　白
-----------
赤  0.1 0.2
緑  0.2 0.3
青  0.7 0.5
```

表2. 上記の容器から、赤、緑、または青にランダムに発光するランプが発光した際に、
ランダムに光る別の白色のランプが手元にあるとして、それが光る確率。

```console
　　　　　　　　　　　　赤　緑　青
-----------------------------------------
白色のランプが光る  　　0.8 0.9 0.9
白色のランプが光らない  0.2 0.1 0.1
```

ここで、表1 と表2 の結合を考えます。

表1 に着目すると、黒いボールを選んだ後に赤いランプが発行し (0.1)、
表2 に着目すると、赤いランプが発行した際に白色のランプが光る (0.8) とします。
そのような確率は 0.1 * 0.8 = 0.08 になります。

同様に、緑のボールについても表1 に着目すると、黒いボールを選んだ後に緑のボールを選び (0.2)、
表2 に着目すると、緑のランプが発行した際に白色のランプが光る (0.9) とします。
そのような確率は 0.2 * 0.9 = 0.18 になります。

同様に、青いボールについても表1 に着目すると、黒いボールを選んだ後に青いボールを選び (0.7)、
表2 に着目すると、青いランプが発行した際に白色のランプが光る (0.9) とします。
そのような確率は 0.7 * 0.9 = 0.63 になります。

上記確率を赤、緑、および青いランプの発光について総和すると、0.08 + 0.18 + 0.63 = 0.89 = 89/100

表1 と表2 のすべてのセルについて同様な計算をすると、次のような表を得ます。

表3. 上記の容器から、黒または白のボールを 1 個選び、
ランダムに光る別の白色のランプが手元にあるとして、それが光る確率。
```console
　　　　　　　　　黒　　白
-----------------------------------------
白色のランプが光る  　　89/100 22/25
白色のランプが光らない  11/100 3/25
```


本スクリプトを用いて計算すると次のようになります。ball_lamp.py を参照ください。

```Python
from fractions import Fraction # 分数を取り扱うために Fraction をインポートします。
import markov_tensor # 結合演算 composition を用いるためにインポートします。

"""
　　黒　白
-----------
赤  0.1 0.2
緑  0.2 0.3
青  0.7 0.5
"""

# 表1 の Python の辞書による表現です。
tensor_a = {
    "profile": [[['黒', '白']], [['赤', '緑', '青']]], 
    "strands": {
        "[[['黒']], [['赤']]]": Fraction(1, 10), 
        "[[['黒']], [['緑']]]": Fraction(2, 10), 
        "[[['黒']], [['青']]]": Fraction(7, 10), 
        "[[['白']], [['赤']]]": Fraction(2, 10), 
        "[[['白']], [['緑']]]": Fraction(3, 10), 
        "[[['白']], [['青']]]": Fraction(5, 10)
    }
}

"""
　　　　　　　　　　　　赤　緑　青
-----------------------------------------
白色のランプが光る  　　0.8 0.9 0.9
白色のランプが光らない  0.2 0.1 0.1
"""

# 表2 の Python の辞書による表現です。
tensor_b = {
    "profile": [[['赤', '緑', '青']], [['白色のランプが光る', '白色のランプが光らない']]], 
    "strands": {
        "[[['赤']], [['白色のランプが光る']]]": Fraction(8, 10),
        "[[['緑']], [['白色のランプが光る']]]": Fraction(9, 10),
        "[[['青']], [['白色のランプが光る']]]": Fraction(9, 10),
        "[[['赤']], [['白色のランプが光らない']]]": Fraction(2, 10),
        "[[['緑']], [['白色のランプが光らない']]]": Fraction(1, 10),
        "[[['青']], [['白色のランプが光らない']]]": Fraction(1, 10)
    }
}

def main():
    # メソッド composition で表1 tensor_ball と表2 tensor_lamp の結合演算を実施し、
    # メソッド print_tensor で標準出力します。
    markov_tensor.print_tensor(markov_tensor.composition(tensor_a, tensor_b))

if __name__ == "__main__":
    main()

```

次のような実行結果を得ます。

```console
profile:  [[['黒', '白']], [['白色のランプが光る', '白色のランプが光らない']]]
[[['黒']], [['白色のランプが光る']]] 89/100
[[['黒']], [['白色のランプが光らない']]] 11/100
[[['白']], [['白色のランプが光る']]] 22/25
[[['白']], [['白色のランプが光らない']]] 3/25
```

### 行と列のラベルがそれぞれ複数ある場合
ここでは、上記の表の行と列のラベルがそれぞれ複数あるような拡張を考えます。

例として、次のような表 4 と 5 を示します。

表4. 黒、または白のボールが混在した容器から、
「黒、または白のボールを 1 個」を選び、
金、または銀のカードが混在したものから
「金、または銀のカードを 1 枚」を選んだ後、

赤、緑、及び青いランプと
桃、および紫のランプが
ランダムに発光する確率の表。

```console
　　　　(黒, 金)　(黒, 銀）（白, 金）（白, 銀）
--------------------------------------------
(赤, 桃)  0.1　　　　0.1　　　0.1　　　0.1 
(赤, 紫)  0.1　　　　0.1　　　0.1　　　0.1
(緑, 桃)  0.1　　　　0.1　　　0.1　　　0.5
(緑, 紫)  0.1　　　　0.1　　　0.5　　　0.1
(青, 桃)  0.1　　　　0.5　　　0.1　　　0.1
(青, 紫)  0.5　　　　0.1　　　0.1　　　0.1
--------------------------------------------
```

表5. 
赤、緑、及び青いランプと桃、および紫のランプがランダムに発光し、
ランダムに光る別の白色のランプが手元に 2 種類あるとして、
白色のランプ 1 が光る確率と、白色のランプ 2 が光る確率の表。

```console
　　　　　　　　　　　　　　　　　　　　　　　  　　　(赤, 桃) (赤, 紫）(緑, 桃) (緑, 紫）(青, 桃) (青, 紫）
-----------------------------------------------------------------------------------------------------------
(白色のランプ 1 が光る, 白色のランプ 2 が光る)  　　　　0.1　　　0.4　　　0.3　　　0.2　　　0.1　　　0.2 
(白色のランプ 1 が光る, 白色のランプ 2 が光らない)  　　0.2　　　0.1　　　0.4　　　0.3　　　0.1　　　0.6
(白色のランプ 1 が光らない, 白色のランプ 2 が光る) 　　 0.3　　　0.2　　　0.1　　　0.4　　　0.2　　　0.1
(白色のランプ 1 が光らない, 白色のランプ 2 が光らない)  0.4　　　0.3　　　0.2　　　0.1　　　0.6　　　0.1
-----------------------------------------------------------------------------------------------------------
```

表6. 黒、または白のボールが混在した容器から、
「黒、または白のボールを 1 個」を選び、
金、または銀のカードが混在したものから
「金、または銀のカードを 1 枚」を選んだ後、

ランダムに光る別の白色のランプが手元に 2 種類あるとして、
白色のランプ 1 が光る確率と、白色のランプ 2 が光る確率の表。

```console
　　　　　　　　　　　　　　　　　　　　　　　　　　　　(黒, 金)　(黒, 銀）（白, 金）（白, 銀）
------------------------------------------------------------------------------------------------
(白色のランプ 1 が光る, 白色のランプ 2 が光る)  　　　　21/100　　17/100　　21/100　　1/4
(白色のランプ 1 が光る, 白色のランプ 2 が光らない)  　　41/100　　21/100　　29/100　　33/100
(白色のランプ 1 が光らない, 白色のランプ 2 が光る) 　　 17/100　　21/100　　29/100　　17/100
(白色のランプ 1 が光らない, 白色のランプ 2 が光らない)  21/100　　41/100　　21/100　　1/4
------------------------------------------------------------------------------------------------
```

上記の表 4 と 5 を Python で表現すると次のようになります。

```Python
# 表4 の Python の辞書による表現です。
tensor_c = {
    "profile": [[['黒', '白'], ['金', '銀']], [['赤', '緑', '青'], ['桃', '紫']]], 
    "strands": {
        "[[['黒'], ['金']], [['赤'], ['桃']]]": Fraction(1, 10), 
        "[[['黒'], ['金']], [['赤'], ['紫']]]": Fraction(1, 10), 
        "[[['黒'], ['金']], [['緑'], ['桃']]]": Fraction(1, 10), 
        "[[['黒'], ['金']], [['緑'], ['紫']]]": Fraction(1, 10), 
        "[[['黒'], ['金']], [['青'], ['桃']]]": Fraction(1, 10), 
        "[[['黒'], ['金']], [['青'], ['紫']]]": Fraction(5, 10), 

        "[[['黒'], ['銀']], [['赤'], ['紫']]]": Fraction(1, 10),
        "[[['黒'], ['銀']], [['赤'], ['桃']]]": Fraction(1, 10), 
        "[[['黒'], ['銀']], [['緑'], ['桃']]]": Fraction(1, 10), 
        "[[['黒'], ['銀']], [['緑'], ['紫']]]": Fraction(1, 10),
        "[[['黒'], ['銀']], [['青'], ['桃']]]": Fraction(5, 10), 
        "[[['黒'], ['銀']], [['青'], ['紫']]]": Fraction(1, 10), 

        "[[['白'], ['金']], [['赤'], ['桃']]]": Fraction(1, 10), 
        "[[['白'], ['金']], [['赤'], ['紫']]]": Fraction(1, 10), 
        "[[['白'], ['金']], [['緑'], ['桃']]]": Fraction(1, 10), 
        "[[['白'], ['金']], [['緑'], ['紫']]]": Fraction(5, 10), 
        "[[['白'], ['金']], [['青'], ['桃']]]": Fraction(1, 10), 
        "[[['白'], ['金']], [['青'], ['紫']]]": Fraction(1, 10), 

        "[[['白'], ['銀']], [['赤'], ['紫']]]": Fraction(1, 10), 
        "[[['白'], ['銀']], [['赤'], ['桃']]]": Fraction(1, 10), 
        "[[['白'], ['銀']], [['緑'], ['桃']]]": Fraction(5, 10), 
        "[[['白'], ['銀']], [['緑'], ['紫']]]": Fraction(1, 10),
        "[[['白'], ['銀']], [['青'], ['桃']]]": Fraction(1, 10), 
        "[[['白'], ['銀']], [['青'], ['紫']]]": Fraction(1, 10)
    }
}

# 表5 の Python の辞書による表現です。
tensor_d = {
    "profile": [[['赤', '緑', '青'], ['桃', '紫']], [['白色のランプ 1 が光る', '白色のランプ 1 が光らない'], ['白色のランプ 2 が光る', '白色のランプ 2 が光らない']]], 
    "strands": {
        "[[['赤'], ['桃']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光る']]]": Fraction(1, 10),
        "[[['赤'], ['桃']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光らない']]]": Fraction(2, 10),
        "[[['赤'], ['桃']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光る']]]": Fraction(3, 10),
        "[[['赤'], ['桃']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光らない']]]": Fraction(4, 10),

        "[[['赤'], ['紫']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光る']]]": Fraction(4, 10),
        "[[['赤'], ['紫']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光らない']]]": Fraction(1, 10),
        "[[['赤'], ['紫']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光る']]]": Fraction(2, 10),
        "[[['赤'], ['紫']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光らない']]]": Fraction(3, 10),

        "[[['緑'], ['桃']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光る']]]": Fraction(3, 10),
        "[[['緑'], ['桃']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光らない']]]": Fraction(4, 10),
        "[[['緑'], ['桃']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光る']]]": Fraction(1, 10),
        "[[['緑'], ['桃']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光らない']]]": Fraction(2, 10),

        "[[['緑'], ['紫']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光る']]]": Fraction(2, 10),
        "[[['緑'], ['紫']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光らない']]]": Fraction(3, 10),
        "[[['緑'], ['紫']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光る']]]": Fraction(4, 10),
        "[[['緑'], ['紫']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光らない']]]": Fraction(1, 10),

        "[[['青'], ['桃']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光る']]]": Fraction(1, 10),
        "[[['青'], ['桃']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光らない']]]": Fraction(1, 10),
        "[[['青'], ['桃']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光る']]]": Fraction(2, 10),
        "[[['青'], ['桃']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光らない']]]": Fraction(6, 10),

        "[[['青'], ['紫']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光る']]]": Fraction(2, 10),
        "[[['青'], ['紫']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光らない']]]": Fraction(6, 10),
        "[[['青'], ['紫']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光る']]]": Fraction(1, 10),
        "[[['青'], ['紫']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光らない']]]": Fraction(1, 10),
    }
}
```

次のような実行結果を得ます。

---
profile:  [[['黒', '白'], ['金', '銀']], [['白色のランプ 1 が光る', '白色のランプ 1 が光らない'], ['白色のランプ 2 が光る', '白色のランプ 2 が光らない']]]
[[['黒'], ['金']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光る']]] 21/100
[[['黒'], ['金']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光らない']]] 41/100
[[['黒'], ['金']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光る']]] 17/100
[[['黒'], ['金']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光らない']]] 21/100
[[['黒'], ['銀']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光る']]] 17/100
[[['黒'], ['銀']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光らない']]] 21/100
[[['黒'], ['銀']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光る']]] 21/100
[[['黒'], ['銀']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光らない']]] 41/100
[[['白'], ['金']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光る']]] 21/100
[[['白'], ['金']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光らない']]] 29/100
[[['白'], ['金']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光る']]] 29/100
[[['白'], ['金']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光らない']]] 21/100
[[['白'], ['銀']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光る']]] 1/4
[[['白'], ['銀']], [['白色のランプ 1 が光る'], ['白色のランプ 2 が光らない']]] 33/100
[[['白'], ['銀']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光る']]] 17/100
[[['白'], ['銀']], [['白色のランプ 1 が光らない'], ['白色のランプ 2 が光らない']]] 1/4
